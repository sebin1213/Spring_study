## [ 스프링 시큐리티 ] - csrf 란 무엇인가..



![image-20220208001431288](C:\Users\1213h\AppData\Roaming\Typora\typora-user-images\image-20220208001431288.png)

> Toy_project를 진행하며 비밀번호 암호화를 위해 스프링 시큐리티를 사용했습니다. 하지만 계속해서 오류가 발생했고 GET 요청은 잘 실행되지만, POST 요청을 하게되면 사진과 같은 403오류가 발생한다는 사실을 알게되었습니다. http.csrf().disable(); 코드를 추가하여 오류를 해결하였지만 csrf가 왜 post요청에서만 오류가 발생하는지 몰랐기에 공부하며 정리해보려 합니다.





>출처
>
>https://codevang.tistory.com/282
>
>https://zzang9ha.tistory.com/341



![image-20220208002513270](C:\Users\1213h\AppData\Roaming\Typora\typora-user-images\image-20220208002513270.png)



### CSRF란

**CSRF**란 웹 애플리케이션의 취약점 중 하나로,  사용자가 자신의 의지와는 무관하게 공격자가 의도한 행위를 특정 웹사이트에 요청하게 하는 공격을 의미합니다.

지금까지 작성한 컨트롤러 코드를 보면 특정 URL에 대한 요청을 처리기 메소드가 받아서 처리 후 뷰 페이지로 돌려주는 형태입니다. 

만약 본인이 블로그에 글을 작성하기 위해 로그인을 한 상태라고 하겠습니다. 댓글을 달기 전 공격자는 글쓰기 페이지를 본인이 정교하게 만든 페이지로 변경하여 바꿔치기합니다. 해당 페이지는 Hidden 타입으로 공격자가 원하는 실제 데이터가 들어있고 사용자가 전송 버튼을 누르면 서버에 요청과 함께 전송됩니다. 

사용자가 제목으로 "안녕하세요"를 입력했지만 이 정보는 서버에 전송되지 않고 공격자가 입력해둔 "돈 빌려드립니다~!"가 입력되는 것입니다. 이렇게 내 계정에 공격자가 만든 게시물이 나도 모르게 올라갈 수 있다는 의미입니다.

실제 서버에서 받아온 뷰 페이지가 아닌 위조된 페이지에서 서버에 요청을 보내는 행위를 걸러내기 위한 방법이 다양하게 존재합니다. 그 중 한 방법이 **CSRF Token**이라는 것을 사용해, 서버에 요청을 올린 페이지가 실제 서버에서 발행한 뷰 페이지가 맞는지 확인하는 것입니다.



#### [ CSRF Token ]

- 서버에 들어온 요청이 실제 서버에서 허용한 요청이 맞는지 확인하기 위한 토큰

서버에서는 뷰 페이지를 발행할 때 랜덤으로 생성된 Token을 같이 준 뒤 사용자 세션에 저장해둡니다. 그리고 사용자가 서버에 작업을 요청할 때 페이지에 Hidden으로 숨어있는 Token 값이 같이 서버로 전송되는데, 서버에서는 이 Token 값이 세션에 저장된 값과 일치하는지 확인하여 해당 요청이 위조된게 아니라는 것을 확인합니다. 일치 여부를 확인한 Token은 바로 폐기하고 새로운 뷰 페이지를 발행할 때마다 새로 생성합니다. 

물론 정상 발행된 페이지 안의 Token값을 확인한 뒤 새로고침 하기 전에 이를 뺏어오는 방법도 있겠지만 훨씬 고도화된 작업이 필요하게 됩니다. 단순히 위조된 페이지만 사용자에게 보여주는 것으로는 CSRF 공격이 불가하다는 의미이고 그만큼 보안 수준이 높아짐을 의미합니다.







#### **CSRF 방어 방법**



- CSRF 공격의 방어는 **조회(GET) 데이터는 방어 대상에 두지 않고** **POST, PATCH, DELETE 메서드에만 적용**을 합니다.



1. POST 방식의 데이터 전송에 CSRF Token 값 추가

 

CSRF 설정을 적용한 뒤부터는 모든 POST 방식의 데이터 전송에 토큰 값이 있어야 합니다. GET 방식에는 적용되지 않습니다. 만약 POST 전송 데이터에 유효한 Token값이 없다면 권한이 없는 페이지에 접근할 때와 동일하게 에러 페이지로 이동됩니다. 

토큰값은 세션에 지정된 이름으로 저장돼있기 때문에 아래와 같이 FORM 태그 안에 삽입해주면 됩니다. 토큰의 이름과 값의 파라미터 이름입니다. Spring Security를 사용하지 않고 그냥 코드에서 Session Attribute에 랜덤 값을 생성해 뷰에 전달해주고 받을 때 검증하는 로직을 짜도 동일하게 작동합니다. 이 과정을 MVC 앞단에서 처리해줍니다.

한줄로 적용이 끝이고, 모든 페이지에 CSRF Token 값이 생성되어 추가됩니다. 토큰 값은 1회용이라 유출되더라도 악용될 가능성이 높지는 않습니다.

```
<s:csrfInput />
```

만약 CSRF Token이 존재하지 않거나, 기존의 Token과 일치하지 않는 경우 **4XX 상태코드를 리턴**합니다.







